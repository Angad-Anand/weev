import { Component, OnInit } from '@angular/core';
import {
  FormControl,
  FormGroup,
  Validators,
  AbstractControl,
  ValidationErrors,
  ValidatorFn,
} from '@angular/forms';
import { BsModalRef } from 'ngx-bootstrap/modal';
import { Subject } from 'rxjs';
import { ICustomerenquiries } from 'src/app/_models/IUserRegistration.models';
import { emailValidator } from 'src/app/utils/email-validator.directive';
import { onlyNumber } from 'src/app/utils/only-number.directive';

@Component({
  selector: 'app-customer-enquiries',
  templateUrl: './customer-enquiries.component.html',
  styleUrls: ['./customer-enquiries.component.scss'],
})
export class CustomerEnquiriesComponent implements OnInit {
  public onClose!: Subject<string | null>;
  title!: string;
  data!: any;
  closeBtnName!: string;
  list!: string[];
  enquiriesForm!: FormGroup;
  userForm: ICustomerenquiries;
  successMessage: string = '';
  formSubmitted: boolean = false;

  constructor(public bsModalRef: BsModalRef) {
    this.userForm = {} as ICustomerenquiries;
  }

  ngOnInit(): void {
    this.onClose = new Subject();
    this.enquiriesForm = new FormGroup({
      username: new FormControl(this.userForm.username, [
        Validators.required,
        Validators.minLength(3),
        Validators.maxLength(45),
      ]),
      email: new FormControl(this.userForm.email, [
        Validators.required,
        Validators.minLength(1),
        Validators.maxLength(50),
        emailValidator(),
      ]),
      mobile: new FormControl(this.userForm.mobile, [
        Validators.required,
        Validators.minLength(10),
        Validators.maxLength(10),
        onlyNumber(),
        this.mobileNumberValidator(),
      ]),
    });
  }

  closed() {
    this.bsModalRef.hide();
    this.onClose.next('');
  }

  onSubmit() {
    if (this.enquiriesForm.invalid) {
      for (const control of Object.keys(this.enquiriesForm.controls)) {
        this.enquiriesForm.controls[control].markAsTouched();
      }
      return;
    }
    this.userForm = this.enquiriesForm.value;
    let data: any = this.userForm;
    this.onClose.next(data);
    // Show success message
    this.formSubmitted = true;
  }

  get username() {
    return this.enquiriesForm.get('username')!;
  }

  get mobile() {
    return this.enquiriesForm.get('mobile')!;
  }

  get email() {
    return this.enquiriesForm.get('email')!;
  }

  mobileNumberValidator(): ValidatorFn {
    return (control: AbstractControl): ValidationErrors | null => {
      const value = control.value;
      if (!value) {
        return null;
      }
      const onlyNumbersRegex = /^[6-9]\d{9}$/;
      return onlyNumbersRegex.test(value) ? null : { onlyNumber: true };
    };
  }
}
